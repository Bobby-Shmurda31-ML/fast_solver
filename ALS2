import numpy as np
import pandas as pd
import scipy.sparse as sp
from implicit.als import ALS
from typing import List, Union, Tuple, Optional, Dict


class ALSRecommender:
    """
    –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ implicit.ALS —Å —É–¥–æ–±–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.
    
    –ü—Ä–∏–º–µ—Ä:
        model = ALSRecommender(factors=64, iterations=20)
        model.fit(user_ids=[1,1,2,3], item_ids=[10,20,10,30], ratings=[5,3,4,5])
        recs = model.predict(user_ids=1, N=5)
    """
    
    def __init__(
        self,
        factors: int = 64,
        regularization: float = 0.01,
        iterations: int = 15,
        alpha: float = 1.0,
        random_state: int = 42,
        use_gpu: bool = False
    ):
        """
        :param factors: —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –ª–∞—Ç–µ–Ω—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
        :param regularization: L2 —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è
        :param iterations: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π ALS
        :param alpha: –≤–µ—Å –¥–ª—è confidence (–¥–ª—è implicit feedback), –∏—Ç–æ–≥–æ–≤—ã–π –≤–µ—Å = 1 + alpha * rating
        :param random_state: seed –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
        :param use_gpu: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPU (—Ç—Ä–µ–±—É–µ—Ç cupy)
        """
        self.model = ALS(
            factors=factors,
            regularization=regularization,
            iterations=iterations,
            alpha=alpha,
            random_state=random_state,
            use_gpu=use_gpu,
            calculate_training_loss=True
        )
        
        # –º–∞–ø–ø–∏–Ω–≥–∏ –º–µ–∂–¥—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ ID –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
        self.user_id_to_index = {}
        self.item_id_to_index = {}
        self.index_to_user_id = {}
        self.index_to_item_id = {}
        
        # –º–∞—Ç—Ä–∏—Ü—ã
        self.user_item_matrix = None
        self.item_user_matrix = None
        
        self.is_fitted = False
        
    
    def fit(
        self, 
        user_ids: List[int], 
        item_ids: List[int], 
        ratings: Optional[List[float]] = None,
        show_progress: bool = True
    ):
        """
        –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏.
        
        :param user_ids: —Å–ø–∏—Å–æ–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        :param item_ids: —Å–ø–∏—Å–æ–∫ ID —Ç–æ–≤–∞—Ä–æ–≤
        :param ratings: —Å–ø–∏—Å–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤/–≤–µ—Å–æ–≤, –µ—Å–ª–∏ None, —Ç–æ –≤—Å–µ = 1.0
        :param show_progress: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è
        """
        # –ø—Ä–æ–≤–µ—Ä–∫–∏
        if len(user_ids) != len(item_ids):
            raise ValueError("–î–ª–∏–Ω—ã user_ids –∏ item_ids –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å")
        
        if ratings is None:
            ratings = np.ones(len(user_ids))
        else:
            if len(ratings) != len(user_ids):
                raise ValueError("–î–ª–∏–Ω–∞ ratings –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å user_ids")
            ratings = np.array(ratings)
        
        # —Å–æ–∑–¥–∞–µ–º –º–∞–ø–ø–∏–Ω–≥–∏ ID -> –∏–Ω–¥–µ–∫—Å
        unique_users = sorted(set(user_ids))
        unique_items = sorted(set(item_ids))
        
        self.user_id_to_index = {uid: idx for idx, uid in enumerate(unique_users)}
        self.item_id_to_index = {iid: idx for idx, iid in enumerate(unique_items)}
        self.index_to_user_id = {idx: uid for uid, idx in self.user_id_to_index.items()}
        self.index_to_item_id = {idx: iid for iid, idx in self.item_id_to_index.items()}
        
        # –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ID –≤ –∏–Ω–¥–µ–∫—Å—ã
        user_indices = [self.user_id_to_index[uid] for uid in user_ids]
        item_indices = [self.item_id_to_index[iid] for iid in item_ids]
        
        # —Å–æ–∑–¥–∞–µ–º —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É user √ó item
        n_users = len(unique_users)
        n_items = len(unique_items)
        
        self.user_item_matrix = sp.csr_matrix(
            (ratings, (user_indices, item_indices)),
            shape=(n_users, n_items)
        )
        
        # —Ç—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä—É–µ–º –¥–ª—è ALS (–Ω—É–∂–Ω–∞ item √ó user)
        self.item_user_matrix = self.user_item_matrix.T.tocsr()
        
        # –æ–±—É—á–µ–Ω–∏–µ
        self.model.fit(self.item_user_matrix, show_progress=show_progress)
        self.is_fitted = True
        
        print(f"‚úÖ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:")
        print(f"   –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {n_users}")
        print(f"   —Ç–æ–≤–∞—Ä–æ–≤: {n_items}")
        print(f"   –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π: {len(user_ids)}")
        print(f"   –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –º–∞—Ç—Ä–∏—Ü—ã: {len(user_ids) / (n_users * n_items):.4%}")
        
        return self
    
    
    def predict(
        self, 
        user_ids: Union[int, List[int]], 
        N: int = 10,
        filter_already_liked: bool = True,
        return_scores: bool = False
    ) -> Dict[int, Union[List[int], Tuple[List[int], List[float]]]]:
        """
        –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(–µ–π).
        
        :param user_ids: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–ø–∏—Å–æ–∫ ID
        :param N: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        :param filter_already_liked: –∏—Å–∫–ª—é—á–∏—Ç—å —É–∂–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        :param return_scores: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ª–∏ —Å–∫–æ—Ä—ã –≤–º–µ—Å—Ç–µ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
        :return: —Å–ª–æ–≤–∞—Ä—å {user_id: [item_ids]} –µ—Å–ª–∏ return_scores=False,
                 {user_id: ([item_ids], [scores])} –µ—Å–ª–∏ return_scores=True
        """
        if not self.is_fitted:
            raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞! –í—ã–∑–æ–≤–∏—Ç–µ fit() —Å–Ω–∞—á–∞–ª–∞.")
        
        # –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å–ø–∏—Å–∫—É
        if isinstance(user_ids, (int, np.integer)):
            user_ids = [user_ids]
        
        results = {}
        
        for user_id in user_ids:
            # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–µ
            if user_id not in self.user_id_to_index:
                print(f"‚ö†Ô∏è  user {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã.")
                # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                item_popularity = np.array(self.user_item_matrix.sum(axis=0)).flatten()
                top_items_idx = np.argsort(-item_popularity)[:N]
                top_items = [self.index_to_item_id[idx] for idx in top_items_idx]
                top_scores = item_popularity[top_items_idx]
                
                if return_scores:
                    results[user_id] = (top_items, top_scores.tolist())
                else:
                    results[user_id] = top_items
                continue
            
            user_idx = self.user_id_to_index[user_id]
            
            # –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            recs = self.model.recommend(
                userid=user_idx,
                user_items=self.user_item_matrix[user_idx],
                N=N,
                filter_already_liked_items=filter_already_liked
            )
            
            # –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ ID
            item_indices, scores = recs
            item_ids_result = [self.index_to_item_id[idx] for idx in item_indices]
            
            if return_scores:
                results[user_id] = (item_ids_result, scores.tolist())
            else:
                results[user_id] = item_ids_result
        
        return results
    
    
    def similar_items(
        self, 
        item_id: int, 
        N: int = 10
    ) -> Tuple[List[int], List[float]]:
        """
        –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã.
        
        :param item_id: ID —Ç–æ–≤–∞—Ä–∞
        :param N: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
        :return: –∫–æ—Ä—Ç–µ–∂ (item_ids, scores) - —Å–ø–∏—Å–∫–∏ –ø–æ—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏—Ö —Å–∫–æ—Ä–æ–≤
        """
        if not self.is_fitted:
            raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞!")
        
        if item_id not in self.item_id_to_index:
            raise ValueError(f"Item {item_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        item_idx = self.item_id_to_index[item_id]
        
        similar = self.model.similar_items(itemid=item_idx, N=N+1)  # +1 —Ç.–∫. —Å–∞–º —Ç–æ–≤–∞—Ä –≤–∫–ª—é—á–µ–Ω
        item_indices, scores = similar
        
        # —É–±–∏—Ä–∞–µ–º —Å–∞–º —Ç–æ–≤–∞—Ä –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ ID
        result_items = []
        result_scores = []
        
        for idx, score in zip(item_indices, scores):
            if idx == item_idx:
                continue
            result_items.append(self.index_to_item_id[idx])
            result_scores.append(score)
            if len(result_items) >= N:
                break
        
        return result_items, result_scores
    
    
    def similar_users(
        self, 
        user_id: int, 
        N: int = 10
    ) -> Tuple[List[int], List[float]]:
        """
        –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
        
        :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param N: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        :return: –∫–æ—Ä—Ç–µ–∂ (user_ids, scores) - —Å–ø–∏—Å–∫–∏ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö —Å–∫–æ—Ä–æ–≤
        """
        if not self.is_fitted:
            raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞!")
        
        if user_id not in self.user_id_to_index:
            raise ValueError(f"User {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        user_idx = self.user_id_to_index[user_id]
        
        similar = self.model.similar_users(userid=user_idx, N=N+1)
        user_indices, scores = similar
        
        # —É–±–∏—Ä–∞–µ–º —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        result_users = []
        result_scores = []
        
        for idx, score in zip(user_indices, scores):
            if idx == user_idx:
                continue
            result_users.append(self.index_to_user_id[idx])
            result_scores.append(score)
            if len(result_users) >= N:
                break
        
        return result_users, result_scores
    
    
    def get_user_items(self, user_id: int) -> Tuple[List[int], List[float]]:
        """
        –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :return: –∫–æ—Ä—Ç–µ–∂ (item_ids, ratings) - —Ç–æ–≤–∞—Ä—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        if not self.is_fitted:
            raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞!")
        
        if user_id not in self.user_id_to_index:
            return [], []
        
        user_idx = self.user_id_to_index[user_id]
        user_row = self.user_item_matrix[user_idx]
        
        # –ø–æ–ª—É—á–∞–µ–º –Ω–µ–Ω—É–ª–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        item_indices = user_row.nonzero()[1]
        ratings = user_row.data
        
        item_ids = [self.index_to_item_id[idx] for idx in item_indices]
        
        return item_ids, ratings.tolist()
    
    
    def predict_for_new_user(
        self,
        item_ids: List[int],
        ratings: Optional[List[float]] = None,
        N: int = 10
    ) -> Tuple[List[int], List[float]]:
        """
        —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç).
        
        :param item_ids: —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        :param ratings: —Ä–µ–π—Ç–∏–Ω–≥–∏ –¥–ª—è —ç—Ç–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
        :param N: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        :return: –∫–æ—Ä—Ç–µ–∂ (recommended_items, scores)
        """
        if not self.is_fitted:
            raise ValueError("–ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞!")
        
        if ratings is None:
            ratings = np.ones(len(item_ids))
        
        # –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ID –≤ –∏–Ω–¥–µ–∫—Å—ã (—Ç–æ–ª—å–∫–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã)
        item_indices = []
        valid_ratings = []
        
        for iid, rating in zip(item_ids, ratings):
            if iid in self.item_id_to_index:
                item_indices.append(self.item_id_to_index[iid])
                valid_ratings.append(rating)
        
        if len(item_indices) == 0:
            print("‚ö†Ô∏è  –Ω–∏ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö")
            return [], []
        
        # —Å–æ–∑–¥–∞–µ–º –≤–µ–∫—Ç–æ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        n_items = len(self.item_id_to_index)
        new_user_vector = sp.csr_matrix(
            (valid_ratings, ([0] * len(item_indices), item_indices)),
            shape=(1, n_items)
        )
        
        # –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recs = self.model.recommend(
            userid=0,  # —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π ID
            user_items=new_user_vector[0],
            N=N,
            recalculate_user=True  # –≤–∞–∂–Ω–æ!
        )
        
        item_indices_result, scores = recs
        item_ids_result = [self.index_to_item_id[idx] for idx in item_indices_result]
        
        return item_ids_result, scores.tolist()


# ===== –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø =====

if __name__ == "__main__":
    
    # 1. —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    print("=" * 60)
    print("–ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ALSRecommender")
    print("=" * 60)
    
    # –¥–∞–Ω–Ω—ã–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ—Ç—Ä—è—Ç —Ñ–∏–ª—å–º—ã
    user_ids =  [101, 101, 101, 102, 102, 102, 103, 103, 104, 104, 104]
    item_ids =  [501, 502, 503, 502, 504, 505, 501, 503, 502, 503, 505]
    ratings =   [5.0, 3.0, 4.0, 4.0, 5.0, 2.0, 5.0, 3.0, 4.0, 5.0, 3.0]
    
    # 2. —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    print("\nüìö –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...")
    model = ALSRecommender(
        factors=32,
        regularization=0.01,
        iterations=20,
        alpha=1.0
    )
    
    model.fit(user_ids, item_ids, ratings)
    
    # 3. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–ª–æ–≤–∞—Ä—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    print("\nüéØ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è user 101:")
    recs = model.predict(user_ids=101, N=3)
    print(f"   {recs}")
    
    # 4. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–æ —Å–∫–æ—Ä–∞–º–∏
    print("\nüéØ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è user 101 —Å–æ —Å–∫–æ—Ä–∞–º–∏:")
    recs_with_scores = model.predict(user_ids=101, N=3, return_scores=True)
    for user_id, (items, scores) in recs_with_scores.items():
        print(f"   user {user_id}:")
        for item, score in zip(items, scores):
            print(f"     —Ñ–∏–ª—å–º {item}: score = {score:.4f}")
    
    # 5. –∏—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    print("\nüìú –∏—Å—Ç–æ—Ä–∏—è user 101:")
    hist_items, hist_ratings = model.get_user_items(101)
    for item, rating in zip(hist_items, hist_ratings):
        print(f"   —Ñ–∏–ª—å–º {item}: rating = {rating}")
    
    # 6. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    print("\nüéØ –±–∞—Ç—á —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è users [101, 102]:")
    batch_recs = model.predict(user_ids=[101, 102], N=2)
    for user_id, items in batch_recs.items():
        print(f"   user {user_id}: {items}")
    
    # 7. –ø–æ—Ö–æ–∂–∏–µ —Ñ–∏–ª—å–º—ã
    print("\nüé¨ –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ —Ñ–∏–ª—å–º 502:")
    sim_items, sim_scores = model.similar_items(item_id=502, N=3)
    for item, score in zip(sim_items, sim_scores):
        print(f"   —Ñ–∏–ª—å–º {item}: similarity = {score:.4f}")
    
    # 8. –ø–æ—Ö–æ–∂–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    print("\nüë• –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ user 101:")
    sim_users, sim_scores = model.similar_users(user_id=101, N=2)
    for user, score in zip(sim_users, sim_scores):
        print(f"   user {user}: similarity = {score:.4f}")
    
    # 9. —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç
    print("\nüÜï –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Å–º–æ—Ç—Ä–µ–ª 501, 503):")
    new_recs, new_scores = model.predict_for_new_user(
        item_ids=[501, 503],
        ratings=[5.0, 4.0],
        N=3
    )
    for item, score in zip(new_recs, new_scores):
        print(f"   —Ñ–∏–ª—å–º {item}: score = {score:.4f}")
    
    print("\n" + "=" * 60)
